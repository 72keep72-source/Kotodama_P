<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>言霊のプロトコル</title>
    <style>
        body { background-color: #1a1a1a; color: #f0f0f0; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #game-container { width: 80%; max-width: 800px; height: 90%; border: 1px solid #444; display: flex; flex-direction: column; background-color: #2b2b2b; }
        #game-log { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #444; white-space: pre-wrap; }
        .ai-response { color: #a5d6a7; }
        .user-command { color: #81d4fa; }
        #input-area { display: flex; padding: 10px; }
        #user-input { flex-grow: 1; background-color: #333; color: #f0f0f0; border: 1px solid #555; padding: 10px; font-size: 16px; }
        #send-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-log"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="どうする？">
            <button id="send-button">送信</button>
        </div>
    </div>

<script>
    const API_URL = '/.netlify/functions/callai';
    const RULEBOOK = `あなたは「言霊のプロトコル」というテキストRPGの優秀なゲームマスターです。以下はゲームの世界設定とルールです。これを厳守し、プレイヤーとの対話を行ってください。# 世界設定\n舞台は剣と魔法の世界「アシ ラ」。古代文明の遺跡や魔物が出るダンジョンが点在し、神秘的な雰囲気が漂っている。また、様々な概念に神が宿るとされています。人の気配のない魔物の巣窟もあれば、とても栄えた人の街もある世界です。プレイヤーのスタート地点の「囁きの森」の夜です。とても静かで、比較的安全な森ですが、低いレベルのままでは危険な森です。# ルール\n- 最初の文言は固定です。『あなたは深い闇に包まれた、囁きの森に倒れている。冷たい地面の感触が、頬に伝わる。満月の光が、木々の間からこぼれ落ち、あなたの顔に淡く照らされる。頭はズキズキと痛む。あなたは何も思い出せない。自分の名前すら…。 古びた石碑が、すぐそばに立っている。その表面には、苔むした文字が刻まれているが、読めない。静寂が森全体を覆い、時折、遠くから聞こえる獣の鳴き声が、不気味な雰囲気をさらに強めている。あなたは、記憶を失った旅人だ。 まずは、あなたの名前を決めてください。』\n- 名前はプレイヤーが自分で決めます。\n- プレイヤーの最初の場所は「囁きの森」の古い石碑の前で倒れてます。\n- プレイヤーは記憶喪失の旅人です。\n- 最初にプレイヤーの名前を確定させてください。\n- 名前が決まったらそのまま持ち物判定をすること。1つから3つ、ランダムで確定します。\n- そしてどのように行動するか聞いてください。\n- プレイヤーを理不尽に殺してはいけません。\n- プレイヤーの面白い行動には、面白い結果を返してください。\n- 状況説明は『』で、NPCのセリフは「」で囲んでください。\n- 最終的な目的は、世界のどこかにある『失われた記憶のコア』を見つけることです。\n- あなたはテキストベースの RPG の優れたゲームマスターです。単なる AI アシスタントとして行動しないでください。\n- あなたはゲームマスターとして、情景を描写してください。\n- 全ての応答は、必ず日本語で行ってください。`;
    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    let conversationHistory = [];

    async function callAI() {
        addLog('考え中...', 'ai-response');
        try {
            const requestData = { contents: conversationHistory };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'APIからの応答がありませんでした。');
            }
            const data = await response.json();
            const aiText = data.candidates[0]?.content?.parts[0]?.text || "（応答がありませんでした）";
            conversationHistory.push({ role: 'model', parts: [{ text: aiText }] });
            const thinkingElement = gameLog.lastChild;
            thinkingElement.textContent = aiText;
        } catch (error) {
            addLog('エラーが発生しました: ' + error.message, 'ai-response');
        }
    }

    function addLog(text, className) {
        const newLine = document.createElement('p');
        newLine.textContent = text;
        if (className) {
            newLine.classList.add(className);
        }
        gameLog.appendChild(newLine);
        gameLog.scrollTop = gameLog.scrollHeight;
        return newLine;
    }

    function handleUserCommand() {
        const command = userInput.value;
        if (command === '') return;
        addLog('> ' + command, 'user-command');
        userInput.value = '';
        conversationHistory.push({ role: 'user', parts: [{ text: command }] });
        callAI();
    }
    
    sendButton.addEventListener('click', handleUserCommand);
    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            handleUserCommand();
        }
    });

    async function startGame() {
        gameLog.innerHTML = ''; 
        conversationHistory = [
            { role: 'user', parts: [{ text: RULEBOOK + "\n\nゲームマスターとして、ルールに厳密に従ってゲームを開始してください。" }] }
        ];
        await callAI();
    }

    startGame();
</script>
</body>
</html>