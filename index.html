<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>言霊のプロトコル</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scenarios/rulebook_1st.js"></script>
    <style>
        :root { --main-bg: #1a1a1a; --container-bg: #2b2b2b; --border-color: #444; --text-color: #f0f0f0; --accent-color: #4CAF50; --ai-text: #a5d6a7; --user-text: #81d4fa; --danger-color: #c9302c; --twitter-color: #1DA1F2; }
        html, body { height: 100%; }
        body { background-color: var(--main-bg); color: var(--text-color); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; }
        header { background-color: var(--container-bg); padding: 10px 20px; text-align: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.2em; }
        #game-wrapper { display: flex; width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; box-sizing: border-box; flex-grow: 1; overflow: hidden; }
        #game-container { width: 70%; height: 100%; display: flex; flex-direction: column; background-color: var(--container-bg); border: 1px solid var(--border-color); }
        #game-log { flex-grow: 1; padding: 20px; overflow-y: auto; white-space: pre-wrap; }
        .ai-response { color: var(--ai-text); }
        .user-command { color: var(--user-text); }
        #actions-container { padding: 10px 20px; border-bottom: 1px solid var(--border-color); }
        .action-button { background-color: var(--accent-color); color: white; border: none; padding: 12px; margin: 5px; cursor: pointer; font-size: 15px; border-radius: 5px; transition: all 0.2s ease; }
        .action-button:hover { filter: brightness(1.2); }
        .action-button.fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        #input-area { display: flex; padding: 10px; }
        #user-input { flex-grow: 1; background-color: #333; color: var(--text-color); border: 1px solid #555; padding: 10px; font-size: 16px; }
        #user-input:disabled { background-color: #444; cursor: not-allowed; }
        #send-button { background-color: var(--accent-color); color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; }
        #sidebar { width: 30%; height: 100%; margin-left: 20px; display: flex; flex-direction: column; }
        #status-container { flex-grow: 1; padding: 20px; background-color: var(--container-bg); border: 1px solid var(--border-color); overflow-y: auto; margin-bottom: 20px; }
        #status-container h2 { color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 20px; }
        #status-container h2:first-child { margin-top: 0; }
        #player-name-display { font-size: 1.5em; color: var(--accent-color); text-align: center; margin-bottom: 20px; word-break: break-all; }
        #status-display p { display: flex; justify-content: space-between; margin: 10px 0; font-size: 16px; }
        #status-display span { font-weight: bold; }
        .stat-value { color: var(--user-text); }
        .stat-change { margin-left: 10px; color: var(--ai-text); animation: fadeInAndOut 2s ease-in-out forwards; }
        #inventory-display p { color: var(--text-color); font-size: 15px; margin: 5px 0; }
        #system-menu { flex-shrink: 0; }
        .system-button { width: 100%; padding: 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; text-align: center; text-decoration: none; display: block; box-sizing: border-box; }
        .system-button.share { background-color: var(--twitter-color); }
        .system-button.share:hover { background-color: #0c85d0; }
        #slot-selector-container { display: flex; margin-bottom: 10px; }
        #slot-selector { flex-grow: 1; background-color: #333; color: var(--text-color); border: 1px solid #555; padding: 10px; font-size: 16px; }
        #start-button, #delete-slot-button { color: white; border: none; margin-left: 10px; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px; }
        #start-button { background-color: var(--accent-color); }
        #delete-slot-button { background-color: var(--danger-color); }
        @keyframes fadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.95); } }
        @keyframes fadeInAndOut { 0% { opacity: 0; transform: translateY(5px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; } 100% { opacity: 0; } }
        @media (max-width: 800px) {
            body { height: auto; }
            #game-wrapper { flex-direction: column; padding: 10px; }
            #game-container, #sidebar { width: 100%; margin-left: 0; }
            #sidebar { margin-top: 20px; height: auto; }
        }
    </style>
</head>
<body>
    <header><h1>言霊のプロトコル</h1></header>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="game-log"></div>
            <div id="actions-container"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="セーブデータを選択してください">
                <button id="send-button">送信</button>
            </div>
        </div>
        <div id="sidebar">
            <div id="status-container">
                <div id="slot-selector-container">
                    <select id="slot-selector"></select>
                    <button id="start-button">開始</button>
                    <button id="delete-slot-button">削除</button>
                </div>
                <div id="player-name-display"></div>
                <h2>ステータス</h2>
                <div id="status-display"></div>
                <h2>本日の行動回数</h2>
                <p id="action-count-display">0 / 20</p>
                <h2>持ち物 (5つまで)</h2>
                <div id="inventory-display"></div>
            </div>
            <div id="system-menu">
                <a class="system-button share" href="https://twitter.com/intent/tweet?text=%E2%96%BCAI%E3%81%A8%E4%BD%9C%E3%82%8BRPG%E3%80%8E%E8%A8%80%E9%9C%8A%E3%81%AE%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%80%8F%0Ahttps%3A%2F%2Fhelpful-bavarois-b141f3.netlify.app%2F%0A%23%E8%A8%80%E9%9C%8A%E3%81%AE%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB" target="_blank" rel="noopener noreferrer">Xにシェアする</a>
            </div>
        </div>
    </div>
<script>
    const API_URL = '/.netlify/functions/callai';
    const DAILY_ACTION_LIMIT = 20;
    const MAX_INVENTORY_SIZE = 5;
    const MAX_SAVE_SLOTS = 3;

    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const statusDisplay = document.getElementById('status-display');
    const actionCountDisplay = document.getElementById('action-count-display');
    const actionsContainer = document.getElementById('actions-container');
    const playerNameDisplay = document.getElementById('player-name-display');
    const inventoryDisplay = document.getElementById('inventory-display');
    const slotSelector = document.getElementById('slot-selector');
    const startButton = document.getElementById('start-button');
    const deleteSlotButton = document.getElementById('delete-slot-button');

    let gameSlots = [];
    let activeSlotId = null;
    let conversationHistory = [];
    let playerStats = {};
    let dailyActions = { date: '', count: 0 };
    let playerName = '';
    let inventory = [];

    function saveGameSlots() {
        const activeSlot = gameSlots.find(slot => slot.id == activeSlotId);
        if (activeSlot) {
            activeSlot.history = conversationHistory;
            activeSlot.stats = playerStats;
            activeSlot.actions = dailyActions;
            activeSlot.name = playerName;
            activeSlot.inventory = inventory;
        }
        localStorage.setItem('rpgGameSlots', JSON.stringify(gameSlots));
        if (activeSlotId) {
            localStorage.setItem('rpgActiveSlotId', activeSlotId);
        } else {
            localStorage.removeItem('rpgActiveSlotId');
        }
    }

    function loadGame(slotId) {
        clearGameScreen();
        const slot = gameSlots.find(s => s.id == slotId);

        if (slot) {
            activeSlotId = slot.id;
            conversationHistory = slot.history || [];
            playerStats = slot.stats || {};
            dailyActions = slot.actions || { date: '', count: 0 };
            playerName = slot.name || 'ななしの旅人';
            inventory = slot.inventory || [];
            
            rebuildLog();

            const lastTurn = conversationHistory[conversationHistory.length - 1];
            if (lastTurn && lastTurn.role === 'model') {
                const lines = lastTurn.parts[0].text.split('\n');
                const actions = lines.filter(line => line.startsWith('[ACTION]')).map(line => line.replace('[ACTION] ', ''));
                displayActions(actions);
            }
        } else {
            activeSlotId = null;
            addLog('ステータス上のプルダウンメニューから、続きを遊ぶデータを選択するか、「開始」ボタンで新しい冒険を開始してください。', 'ai-response');
            toggleInput(true);
        }
        updateAllDisplays();
    }

    function createNewGame() {
        if (gameSlots.length >= MAX_SAVE_SLOTS) {
            alert(`セーブスロットは${MAX_SAVE_SLOTS}つまでです。`);
            return;
        }
        
        clearGameScreen();
        playerStats = generateStats();
        playerName = 'ななしの旅人';
        inventory = [];
        dailyActions = { date: new Date().toISOString().slice(0, 10), count: 0 };
        conversationHistory = [];
        const newSlot = {
            id: Date.now(),
            name: playerName,
            stats: playerStats,
            history: conversationHistory,
            inventory: inventory,
            actions: dailyActions
        };
        newSlot.history.push({ role: 'user', parts: [{ text: RULEBOOK + `\n\nあなたの能力値は ${JSON.stringify(newSlot.stats)} です。この情報も踏まえて、ゲームマスターとして、ルールに厳密に従ってゲームを開始してください。` }] });
        gameSlots.push(newSlot);
        activeSlotId = newSlot.id;
        
        updateSlotSelector();
        updateAllDisplays();
        callAI();
    }

    function deleteSelectedSlot() {
        const selectedId = slotSelector.value;
        if (selectedId) {
            const slotToDelete = gameSlots.find(s => s.id == selectedId);
            if (confirm(`本当にセーブデータ「${slotToDelete.name}」を削除しますか？`)) {
                gameSlots = gameSlots.filter(s => s.id != selectedId);
                activeSlotId = null;
                saveGameSlots();
                window.location.reload();
            }
        } else {
            alert('削除するデータがありません。');
        }
    }

    function updateSlotSelector() {
        slotSelector.innerHTML = '';
        if (gameSlots.length === 0) {
            // セーブデータがない場合は選択肢を表示しない
        } else {
            gameSlots.forEach((slot, index) => {
                const option = document.createElement('option');
                option.value = slot.id;
                option.textContent = `データ${index + 1}: ${slot.name || '（名前未設定）'}`;
                slotSelector.appendChild(option);
            });
        }
        
        if (gameSlots.length < MAX_SAVE_SLOTS) {
            const newGameOption = document.createElement('option');
            newGameOption.value = 'new';
            newGameOption.textContent = '--- 新しく冒険を始める ---';
            slotSelector.appendChild(newGameOption);
        }
        
        slotSelector.value = activeSlotId ? activeSlotId : 'new';
    }

    function clearGameScreen() {
        gameLog.innerHTML = '';
        actionsContainer.innerHTML = '';
        playerStats = {};
        playerName = '';
        inventory = [];
        dailyActions = { date: '', count: 0 };
        updateAllDisplays();
        toggleInput(false);
    }
    
    function updateAllDisplays() {
        updatePlayerNameDisplay();
        updateStatusDisplay();
        updateActionCountDisplay();
        updateInventoryDisplay();
    }

    function rebuildLog() {
        gameLog.innerHTML = '';
        (conversationHistory || []).slice(1).forEach(turn => {
            const text = turn.parts[0].text;
            if (turn.role === 'user') {
                addLog('> ' + text, 'user-command');
            } else {
                const storyText = text.split('\n').filter(line => !line.startsWith('[')).join('\n');
                addLog(storyText, 'ai-response');
            }
        });
    }

    function generateStats() { const rollDice = () => Math.floor(Math.random() * 16) + 3; const initialHP = 100; return { "HP": { current: initialHP, max: initialHP }, "STR": rollDice(), "DEX": rollDice(), "CON": rollDice(), "INT": rollDice(), "WIS": rollDice(), "CHA": rollDice() }; }
    function updatePlayerNameDisplay() { playerNameDisplay.textContent = playerName; }
    function updateInventoryDisplay() { inventoryDisplay.innerHTML = ''; if (!inventory || inventory.length === 0) { inventoryDisplay.innerHTML = '<p>何も持っていない</p>'; } else { inventory.forEach(item => { const p = document.createElement('p'); p.textContent = `・${item}`; inventoryDisplay.appendChild(p); }); } }
    function updateStatusDisplay(changes = {}) { statusDisplay.innerHTML = ''; if (!playerStats || Object.keys(playerStats).length === 0) { return; } for (const [key, value] of Object.entries(playerStats)) { const p = document.createElement('p'); const label = document.createElement('span'); label.textContent = `${key}:`; const valueContainer = document.createElement('span'); const valueSpan = document.createElement('span'); valueSpan.className = 'stat-value'; if (key === 'HP') { valueSpan.textContent = `${value.current} / ${value.max}`; } else { valueSpan.textContent = value; } valueContainer.appendChild(valueSpan); if (changes[key]) { const changeSpan = document.createElement('span'); changeSpan.className = 'stat-change'; changeSpan.textContent = `(${changes[key]})`; valueContainer.appendChild(changeSpan); setTimeout(() => { if(changeSpan) changeSpan.remove(); }, 2000); } p.appendChild(label); p.appendChild(valueContainer); statusDisplay.appendChild(p); } }
    function updateActionCountDisplay() { actionCountDisplay.textContent = `${dailyActions?.count || 0} / ${DAILY_ACTION_LIMIT}`; }
    function displayActions(actions) {
        actionsContainer.innerHTML = '';
        if (actions && actions.length > 0) {
            actions.forEach(actionText => {
                const button = document.createElement('button');
                button.textContent = actionText;
                button.className = 'action-button';
                button.addEventListener('click', () => {
                    actionsContainer.querySelectorAll('.action-button').forEach(btn => btn.disabled = true);
                    button.classList.add('fade-out');
                    setTimeout(() => {
                        handleUserCommand(actionText);
                    }, 500);
                });
                actionsContainer.appendChild(button);
            });
        }
        // toggleInputの呼び出しをすべて削除
    }
    function toggleInput(disabled) { userInput.disabled = disabled; sendButton.disabled = disabled; userInput.placeholder = disabled ? '[ACTION] ボタンから選択してください' : 'どうする？'; }

    async function callAI() {
        if (!activeSlotId) return;
        addLog('考え中...', 'ai-response');
        toggleInput(true);
        try {
            const requestData = { contents: conversationHistory };
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || 'APIからの応答がありませんでした。'); }
            const data = await response.json();
            const fullAiText = data.candidates[0]?.content?.parts[0]?.text || "（応答がありませんでした）";
            
            conversationHistory.push({ role: 'model', parts: [{ text: fullAiText }] });
            let storyText = fullAiText;
            const statChanges = {};
            const nameMatch = storyText.match(/\[NAME\]\s*(.+)/); if (nameMatch) { playerName = nameMatch[1].trim(); storyText = storyText.replace(/\[NAME\].+/, '').trim(); }
            const statRegex = /\[STAT\]\s*(\w+)\s*([+\-])\s*(\d+)/g; let statMatch; while ((statMatch = statRegex.exec(storyText)) !== null) { const [fullMatch, stat, operator, valueStr] = statMatch; const value = parseInt(valueStr, 10); if (playerStats && playerStats[stat] !== undefined) { if (operator === '+') playerStats[stat] += value; else playerStats[stat] -= value; statChanges[stat] = `${operator}${value}`; } } storyText = storyText.replace(statRegex, '').trim();
            const itemAddMatch = storyText.match(/\[ITEM_ADD\]\s*(.+)/); if (itemAddMatch && inventory.length < MAX_INVENTORY_SIZE) { inventory.push(itemAddMatch[1].trim()); storyText = storyText.replace(/\[ITEM_ADD\].+/, '').trim(); }
            const itemRemoveMatch = storyText.match(/\[ITEM_REMOVE\]\s*(.+)/); if (itemRemoveMatch) { inventory = inventory.filter(item => item !== itemRemoveMatch[1].trim()); storyText = storyText.replace(/\[ITEM_REMOVE\].+/, '').trim(); }
            const damageMatch = storyText.match(/\[DAMAGE\]\s*(\d+)/); if (damageMatch) { const damage = parseInt(damageMatch[1], 10); if(playerStats.HP) { playerStats.HP.current -= damage; if (playerStats.HP.current < 0) playerStats.HP.current = 0; } storyText = storyText.replace(/\[DAMAGE\]\s*\d+/, '').trim(); }
            
            const lines = storyText.split('\n');
            const storyLogText = lines.filter(line => !line.startsWith('[ACTION]')).join('\n');
            const actions = lines.filter(line => line.startsWith('[ACTION]')).map(line => line.replace('[ACTION] ', ''));
            // ... (API通信と応答処理は変更なし) ...
        
        const thinkingElement = gameLog.lastChild;
        thinkingElement.textContent = storyLogText;
        displayActions(actions);

    } catch (error) {
        const thinkingElement = gameLog.lastChild;
        thinkingElement.textContent = 'エラーが発生しました: ' + error.message;
    } finally {
        toggleInput(false); // 処理が成功してもエラーになっても、必ずロックを解除
    }
}

    function handleUserCommand(commandFromButton = null) {
        if (!activeSlotId) { addLog('「開始」ボタンで、新しい冒険を開始してください。', 'ai-response'); return; }
        const command = commandFromButton || userInput.value;
        if (command === '') return;
        const today = new Date().toISOString().slice(0, 10);
        if (dailyActions.date !== today) {
            dailyActions.date = today;
            dailyActions.count = 0;
        }
        if (dailyActions.count >= DAILY_ACTION_LIMIT) {
            addLog('本日の行動回数上限に達しました。また明日、冒険を続けてください。', 'ai-response');
            return;
        }
        addLog('> ' + command, 'user-command');
        userInput.value = '';
        actionsContainer.innerHTML = '';
        dailyActions.count++;
        conversationHistory.push({ role: 'user', parts: [{ text: command }] });
        callAI();
    }

    function addLog(text, className) {
        const newLine = document.createElement('p');
        newLine.textContent = text;
        if (className) { newLine.classList.add(className); }
        gameLog.appendChild(newLine);
        gameLog.scrollTop = gameLog.scrollHeight;
        return newLine;
    }
    
    function startGame() {
        gameSlots = JSON.parse(localStorage.getItem('rpgGameSlots')) || [];
        activeSlotId = localStorage.getItem('rpgActiveSlotId');
        const activeSlotExists = gameSlots.some(slot => slot.id == activeSlotId);
        if (!activeSlotExists) {
            activeSlotId = null;
        }
        updateSlotSelector();
        if (activeSlotId) {
            loadGame(activeSlotId);
        } else {
            loadGame(null);
        }
    }
    
    // --- イベントリスナー ---
    sendButton.addEventListener('click', () => handleUserCommand());
    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            handleUserCommand();
        }
    });

    startButton.addEventListener('click', () => {
        const selectedId = slotSelector.value;
        if (selectedId === 'new') {
            createNewGame();
        } else if (selectedId) {
            loadGame(selectedId);
        }
    });
    
    slotSelector.addEventListener('change', () => {
        const selectedId = slotSelector.value;
        if (selectedId !== 'new') {
            activeSlotId = selectedId;
            localStorage.setItem('rpgActiveSlotId', activeSlotId);
        }
    });

    deleteSlotButton.addEventListener('click', deleteSelectedSlot);
    
    document.addEventListener('DOMContentLoaded', startGame);
</script>
</body>
</html>