<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>言霊のプロトコル</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSSは変更ありません */
        body { background-color: #1a1a1a; color: #f0f0f0; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background-color: #2b2b2b; color: #f0f0f0; padding: 10px 20px; text-align: center; border-bottom: 1px solid #444; flex-shrink: 0; }
        header h1 { margin: 0; font-size: 1.2em; }
        #game-wrapper { display: flex; width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; box-sizing: border-box; flex-grow: 1; overflow: hidden; }
        #game-container { width: 70%; height: 100%; display: flex; flex-direction: column; background-color: #2b2b2b; border: 1px solid #444; }
        #game-log { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #444; white-space: pre-wrap; }
        .ai-response { color: #a5d6a7; }
        .user-command { color: #81d4fa; }
        #input-area { display: flex; padding: 10px; }
        #user-input { flex-grow: 1; background-color: #333; color: #f0f0f0; border: 1px solid #555; padding: 10px; font-size: 16px; }
        #send-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; }
        #sidebar { width: 30%; height: 100%; margin-left: 20px; display: flex; flex-direction: column; }
        #status-container { flex-grow: 1; padding: 20px; background-color: #2b2b2b; border: 1px solid #444; color: #f0f0f0; overflow-y: auto; margin-bottom: 20px; }
        #status-container h2 { color: #4CAF50; border-bottom: 1px solid #444; padding-bottom: 10px; }
        #status-container p { margin: 10px 0; font-size: 16px; }
        #status-container span { color: #81d4fa; font-weight: bold; }
        #system-menu { flex-shrink: 0; }
        #reset-button { width: 100%; padding: 15px; background-color: #c9302c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #reset-button:hover { background-color: #a92824; }
        @media (max-width: 800px) {
            body { height: auto; }
            #game-wrapper { flex-direction: column; padding: 10px; }
            #game-container, #sidebar { width: 100%; margin-left: 0; }
            #sidebar { margin-top: 20px; height: auto; }
            #status-container { margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>言霊のプロトコル</h1>
    </header>

    <div id="game-wrapper">
        <div id="game-container">
            <div id="game-log"></div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="どうする？">
                <button id="send-button">送信</button>
            </div>
        </div>
        
        <div id="sidebar">
            <div id="status-container">
                <h2>ステータス</h2>
                <div id="status-display"></div>
                <h2>本日の行動回数</h2>
                <p id="action-count-display">0 / 20</p>
            </div>
            
            <div id="system-menu">
                <button id="reset-button">はじめからやり直す</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = '/.netlify/functions/callai';
    const DAILY_ACTION_LIMIT = 20;

    const RULEBOOK = `あなたは「言霊のプロトコル」というテキストRPGの優秀なゲームマスターです。以下はゲームの世界設定とルールです。これを厳守し、プレイヤーとの対話を行ってください。
    # 世界設定\n
    舞台は剣と魔法の世界「アシハラ」。
    古代文明の遺跡や魔物が出るダンジョンが点在し、神秘的な雰囲気が漂っている。
    また、様々な概念に神が宿るとされています。人の気配のない魔物の巣窟もあれば、とても栄えた人の街もある世界です。
    プレイヤーのスタート地点の「囁きの森」の夜です。とても静かで、比較的安全な森ですが、低いレベルのままでは危険な森です。
    # ルール\n
    - 最初の文言は固定です。『あなたは深い闇に包まれた、囁きの森に倒れている。冷たい地面の感触が、頬に伝わる。満月の光が、木々の間からこぼれ落ち、あなたの顔に淡く照らされる。頭はズキズキと痛む。あなたは何も思い出せない。自分の名前すら…。 古びた石碑が、すぐそばに立っている。その表面には、苔むした文字が刻まれているが、読めない。静寂が森全体を覆い、時折、遠くから聞こえる獣の鳴き声が、不気味な雰囲気をさらに強めている。あなたは、記憶を失った旅人だ。 まずは、あなたの名前を決めてください。』\n
    - 名前はプレイヤーが自分で決めます。\n- プレイヤーは記憶喪失の旅人です。\n
    - 最初にプレイヤーの名前を確定させてください。\n
    - 名前が決まったらそのまま持ち物判定をすること。1つから3つを、ランダムで確定します。\n
    - そしてどのように行動するか聞いてください。\n
    - プレイヤーを理不尽に殺してはいけません。\n
    - プレイヤーの所持できるアイテムは5つまでです。\n
    - プレイヤーの奇行には意味のある結果を出してください。\n
    - プレイヤーの面白い行動には、面白い結果を返してください。\n
    - 確率の判定が必要な場合は自動的に最適なサイコロを振り、【判定中】と【結果】を返してください。\n
    - サイコロの演出はいらないということです。\n
    - 状況説明は『』で、NPCのセリフは「」で囲んでください。\n
    - 最終的な目的は、世界のどこかにある『失われた記憶のコア』を見つけることです。\n
    - あなたはテキストベースの RPG の優れたゲームマスターです。単なる AI アシスタントとして行動しないでください。\n
    - あなたはゲームマスターとして、情景を描写してください。\n
    - 全ての応答は、必ず日本語で行ってください。`;

    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const statusDisplay = document.getElementById('status-display');
    const actionCountDisplay = document.getElementById('action-count-display');
    const resetButton = document.getElementById('reset-button');

    let conversationHistory = [];
    let playerStats = {};
    let dailyActions = { date: '', count: 0 };

    function saveGame() {
        const saveData = {
            history: conversationHistory,
            stats: playerStats,
            actions: dailyActions
        };
        localStorage.setItem('rpgSaveData', JSON.stringify(saveData));
    }

    function generateStats() {
        const rollDice = () => Math.floor(Math.random() * 16) + 3;
        return {
            "STR": rollDice(), "DEX": rollDice(), "CON": rollDice(),
            "INT": rollDice(), "WIS": rollDice(), "CHA": rollDice()
        };
    }

    function updateStatusDisplay() {
        statusDisplay.innerHTML = '';
        for (const [key, value] of Object.entries(playerStats)) {
            const p = document.createElement('p');
            p.innerHTML = `${key}: <span>${value}</span>`;
            statusDisplay.appendChild(p);
        }
    }
    
    function updateActionCountDisplay() {
        actionCountDisplay.textContent = `${dailyActions.count} / ${DAILY_ACTION_LIMIT}`;
    }

    async function callAI() {
        addLog('考え中...', 'ai-response');
        try {
            const requestData = { contents: conversationHistory };
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || 'APIからの応答がありませんでした。');
            }
            const data = await response.json();
            const aiText = data.candidates[0]?.content?.parts[0]?.text || "（応答がありませんでした）";
            
            conversationHistory.push({ role: 'model', parts: [{ text: aiText }] });
            saveGame();

            const thinkingElement = gameLog.lastChild;
            thinkingElement.textContent = aiText;
        } catch (error) {
            const thinkingElement = gameLog.lastChild;
            thinkingElement.textContent = 'エラーが発生しました: ' + error.message;
        }
    }

    function addLog(text, className) {
        const newLine = document.createElement('p');
        newLine.textContent = text;
        if (className) {
            newLine.classList.add(className);
        }
        gameLog.appendChild(newLine);
        gameLog.scrollTop = gameLog.scrollHeight;
        return newLine;
    }

    function handleUserCommand() {
        const today = new Date().toISOString().slice(0, 10);
        if (dailyActions.date !== today) {
            dailyActions.date = today;
            dailyActions.count = 0;
        }
        if (dailyActions.count >= DAILY_ACTION_LIMIT) {
            addLog('本日の行動回数上限に達しました。また明日、冒険を続けてください。', 'ai-response');
            return;
        }

        const command = userInput.value;
        if (command === '') return;

        addLog('> ' + command, 'user-command');
        userInput.value = '';

        dailyActions.count++;
        updateActionCountDisplay();
        conversationHistory.push({ role: 'user', parts: [{ text: command }] });
        
        callAI();
    }
    
    sendButton.addEventListener('click', handleUserCommand);
    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Enterキーでのフォーム送信を防止
            handleUserCommand();
        }
    });

    resetButton.addEventListener('click', () => {
        if (confirm('本当にすべてのデータをリセットして、はじめからやり直しますか？')) {
            localStorage.removeItem('rpgSaveData');
            window.location.reload();
        }
    });

    function startGame() {
        const savedData = localStorage.getItem('rpgSaveData');

        if (savedData) {
            const data = JSON.parse(savedData);
            conversationHistory = data.history;
            playerStats = data.stats;
            dailyActions = data.actions || { date: '', count: 0 };

            gameLog.innerHTML = '';
            // ▼▼▼ 変更点 ▼▼▼: 最初の履歴（ルールブック）を非表示にするため .slice(1) を追加
            conversationHistory.slice(1).forEach(turn => {
                if (turn.role === 'user') {
                    addLog('> ' + turn.parts[0].text, 'user-command');
                } else {
                    addLog(turn.parts[0].text, 'ai-response');
                }
            });

        } else {
            playerStats = generateStats();
            conversationHistory = [
                { role: 'user', parts: [{ text: RULEBOOK + `\n\nあなたの能力値は ${JSON.stringify(playerStats)} です。この情報も踏まえて、ゲームマスターとして、ルールに厳密に従ってゲームを開始してください。` }] }
            ];
            callAI();
        }
        
        updateStatusDisplay();
        updateActionCountDisplay();
    }

    startGame();
</script>
</body>
</html>